<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Custom Type — Personalised</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bd:#ddd; --muted:#666; }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px}
    .badge{display:inline-block;background:#eef;border:1px solid #99c;padding:4px 8px;border-radius:8px;margin-left:8px;font-size:12px;color:#224}
    .meta{color:#555;margin-top:8px}
    .card{border:1px solid var(--bd); border-radius:12px; padding:12px; margin-top:12px; background:#fff}
    h1,h2{margin:0 0 8px}
    ul{margin:6px 0 0 18px}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    a{color:#06c}
    #err{color:#b00020;margin-top:8px}
  </style>
  .btn{display:inline-block;padding:8px 14px;border:1px solid #99c;background:#eef;border-radius:8px;text-decoration:none}
.btn:hover{background:#e6eefc}

</head>
<body>
  <h1 id="title">Personalised <span class="badge" id="slugBadge"></span></h1>

  <div class="card">
    <h2>Instructions</h2>
    <div id="instructions" class="meta">Loading type details…</div>
  </div>

  <div class="card">
    <h2>Requirements</h2>
    <ul id="reqList"></ul>
  </div>

  <p class="meta" id="info"></p>
<p id="err" class="hidden"></p>

<!-- CTA: Open Designer -->
<p><a id="startLink" class="btn">Open Designer</a></p>

<p><a href="../index.html">← Back</a></p>


  <script>
    // ---------- helpers ----------
    const API_URL = "https://customisationapp-new.vercel.app/api/templates";

    function toSlug(s){
      return String(s||'').toLowerCase().trim()
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }
    function toTitleCase(s){
      return String(s||'').split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
    }
    function getSlug(){
      const hash = (location.hash || '').replace(/^#\/?/, '').split(/[?#]/)[0].trim();
      if (hash) return hash;
      const qs = new URLSearchParams(location.search);
      const t = qs.get('type');
      if (t) return toSlug(t);
      const path = (location.pathname.split('/types/')[1] || '').replace(/\/+$/,'');
      return path.endsWith('.html') ? path.slice(0, -5) : path;
    }
    function mdToHtml(md){
      // tiny, safe-ish markdown -> html (bold, italic, code, line breaks)
      const esc = (s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      let h = esc(String(md||''));
      h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
      h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      h = h.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      return h.replace(/\n/g,'<br>');
    }

    // ---------- render ----------
    function renderMeta(slug, meta, query){
      const title = meta?.title || `${toTitleCase(slug)} — Personalised`;
      document.title = title;
      document.getElementById('title').firstChild.nodeValue = title + ' ';
      document.getElementById('slugBadge').textContent = `route: ${slug}`;

      // instructions
      const instEl = document.getElementById('instructions');
      instEl.innerHTML = meta?.instructions_md ? mdToHtml(meta.instructions_md) : '—';

      // requirements
      const ul = document.getElementById('reqList');
      ul.innerHTML = '';
      (meta?.requirements || []).forEach(item => {
        const li = document.createElement('li'); li.textContent = item; ul.appendChild(li);
      });
      if ((meta?.requirements || []).length === 0) {
        const li = document.createElement('li'); li.textContent = 'No special requirements.'; ul.appendChild(li);
      }

      // context info
      document.getElementById('info').textContent =
        `template_id=${query.get('template_id')||''} · orderId=${query.get('orderId')||''} · name=${query.get('name')||''}`;
    }

    function showError(msg){
      const e = document.getElementById('err');
      e.classList.remove('hidden');
      e.textContent = msg;
    }

    // ---------- boot ----------
    (async function boot(){
      const slug = getSlug() || 'unknown';
      const qs = new URLSearchParams(location.search);

      // Build API URL. Prefer template_id (exact), else fetch list and match by slug.
      const url = new URL(API_URL);
      url.searchParams.set('type', 'kebab'); // so records include .type
      url.searchParams.set('slug', '1');     // optional, for debugging shape
      if (qs.get('template_id')) url.searchParams.set('template_id', qs.get('template_id'));

      let data;
      try {
        const res = await fetch(url.href, { credentials: 'omit', cache: 'no-store' });
        data = await res.json();
      } catch (err) {
        renderMeta(slug, null, qs);
        return showError('Failed to load type details from API.');
      }

      const recs = Array.isArray(data?.records) ? data.records : [];
      // Choose record
      let rec = null;
      if (qs.get('template_id')) {
        rec = recs[0] || null;
      } else {
        rec = recs.find(r => (r.type || toSlug(r.TYPE || '')) === slug) || null;
      }

      const meta = rec?.typeMeta || null;
      renderMeta(slug, meta, qs);
      // Build deep link to the main customiser (re-uses existing renderer)
const startEl = document.getElementById('startLink');
if (startEl) {
  const u = new URL('../index.html', location.href);
  if (rec?.template_id) u.searchParams.set('template_id', rec.template_id);
  if (qs.get('orderId')) u.searchParams.set('orderId', qs.get('orderId'));
  if (qs.get('name'))    u.searchParams.set('name', qs.get('name'));
  if (qs.get('photo'))   u.searchParams.set('photo', qs.get('photo'));
  u.searchParams.set('type', slug);
  startEl.href = u.href;
  startEl.textContent = rec?.name ? `Open Designer — ${rec.name}` : 'Open Designer';
}

      if (!rec) showError('No template record matched this TYPE.');
      else if (!meta) showError('This TYPE has no meta yet. Add fields in Airtable: type_title, type_instructions_md, type_requirements_json.');
    })();
  </script>
</body>
</html>
