<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bang Tidy — Type Router</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bd:#ddd;--muted:#666;--fg:#111;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--fg);}
    h1{margin:0 0 8px;}
    .card{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;margin:12px 0;}
    .muted{color:var(--muted);}
    button{padding:9px 14px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer;}
  </style>
</head>
<body>
  <div class="card">
    <div class="muted" id="routeLine">Loading route…</div>
    <h1 id="pageTitle">Loading…</h1>
  </div>

  <div class="card">
    <div class="muted"><strong>Context</strong></div>
    <div id="ctx">template_id= · orderId= · name=</div>
    <div style="margin-top:8px">
      <button id="openBtn">Open Designer</button>
      <span id="tplName" class="muted" style="margin-left:8px"></span>
    </div>
  </div>

  <script>
  // utils
  const clean = s => String(s||'').replace(/\s+/g,' ').trim();
  const toSlug = s => clean(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  function getParams(){
    const qs = new URLSearchParams(location.search);
    if (qs.toString()) return qs;
    const h = location.hash || "";
    const qPos = h.indexOf("?");
    if (qPos !== -1) return new URLSearchParams(h.slice(qPos + 1));
    return new URLSearchParams("");
  }
  function qp(k){ return getParams().get(k) || ""; }
  function hashSlug(){
    const h = location.hash || "";
    const m = h.match(/^#\/?([^?&]+)/);
    return m ? m[1].trim().toLowerCase() : "";
  }
  function titleCase(s){ return clean(s).replace(/\b[a-z]/g, c => c.toUpperCase()); }

  // API
  const API_BASE = (() => {
    const override = qp('api');
    if (override && /^https?:\/\//i.test(override)) return override;
    return "https://customisationapp-new.vercel.app/api/templates";
  })();

  function normalizeRecord(t){
    const id   = clean(t.template_id);
    const name = clean(t.name);
    const TYPE = clean(t.TYPE || t.type || '');
    const typeKebab = t.type ? clean(t.type) : toSlug(TYPE);
    return { ...t, template_id:id, name, TYPE, type:typeKebab };
  }

  async function fetchTemplates(){
    const url = new URL(API_BASE);
    url.searchParams.set('slug','1');
    url.searchParams.set('type','kebab');
    const r = await fetch(url, { cache:'no-store' });
    const json = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(json));
    return (json.records || []).map(normalizeRecord);
  }

  function pickTemplateByType(records, slug, preferId){
    const list = records.filter(r => (r.type || toSlug(r.TYPE || '')) === slug);
    if (!list.length) return null;
    if (preferId){
      const hit = list.find(r => String(r.template_id||'').toLowerCase() === String(preferId||'').toLowerCase());
      if (hit) return hit;
    }
    const withLayout = list.find(r => (Array.isArray(r.fields) && r.fields.length) || r.layout);
    return withLayout || list[0];
  }

  (async function boot(){
    const slug = hashSlug();
    document.getElementById('routeLine').textContent = `Personalised route: ${slug || '—'}`;

    const template_id = clean(qp('template_id'));
    const orderId = qp('orderId');
    const name = qp('name');
    const photo = qp('photo');

    try{
      const recs = await fetchTemplates();
      const tpl = pickTemplateByType(recs, slug, template_id);

      if (!tpl){
        document.getElementById('pageTitle').textContent = 'Template type not found';
        return;
      }

      const title = `${titleCase(slug)} — Personalised`;
      document.getElementById('pageTitle').textContent = title;

      document.getElementById('ctx').textContent =
        `template_id=${template_id || '(auto ' + tpl.template_id + ')'} · orderId=${orderId || '—'} · name=${name || '—'}`;

      document.getElementById('tplName').textContent = `— ${tpl.name || ''}`;
      document.getElementById('openBtn').onclick = () => {
        try { sessionStorage.setItem('skipRouterOnce','1'); } catch {}
        const p = new URLSearchParams();
        p.set('template_id', template_id || tpl.template_id);
        if (orderId) p.set('orderId', orderId);
        if (name) p.set('name', name);
        if (photo) p.set('photo', photo);
        p.set('noroute','1');
        location.href = `../index.html?${p.toString()}`;
      };
    } catch(err){
      document.getElementById('pageTitle').textContent = 'Load error';
    }
  })();
  </script>
</body>
</html>
