<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bang Tidy — Type Router</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bd:#ddd;--muted:#666;--fg:#111;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--fg);}
    h1{margin:0 0 8px;}
    .card{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;margin:12px 0;}
    .muted{color:var(--muted);}
    button{padding:9px 14px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer;}
    .req li{margin:4px 0;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;}
    .hidden{display:none!important;}
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <div class="muted mono" id="routeLine">Loading route…</div>
      <h1 id="pageTitle">Loading…</h1>
      <div id="instructions" class="muted">—</div>
    </div>

    <div class="card">
      <strong>Requirements</strong>
      <ul id="reqList" class="req"></ul>
      <div id="reqEmpty" class="muted">No special requirements.</div>
    </div>

    <div class="card">
      <div class="muted"><strong>Context</strong></div>
      <div id="ctx" class="mono">template_id= · orderId= · name=</div>
      <div style="margin-top:8px">
        <button id="openBtn">Open Designer</button>
        <span id="tplName" class="muted" style="margin-left:8px"></span>
      </div>
    </div>

    <div id="err" class="card muted hidden"></div>
  </div>

  <script>
  // ------- utils -------
  function getParams(){
    // Prefer normal query string
    const qs = new URLSearchParams(location.search);
    if (qs.toString()) return qs;
    // Fallback: if query ended up inside hash
    const h = location.hash || "";
    const qPos = h.indexOf("?");
    if (qPos !== -1) return new URLSearchParams(h.slice(qPos + 1));
    return new URLSearchParams("");
  }
  function qp(k){ return getParams().get(k) || ""; }
  function hashSlug(){
    const m = (location.hash||"").match(/^#\/?([^?]+)/);
    return m ? m[1].trim().toLowerCase() : "";
  }
  function clean(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
  function toSlug(s){ return clean(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function titleCase(s){ return clean(s).replace(/\b[a-z]/g, c => c.toUpperCase()); }
  function keyLower(s){ return String(s||'').trim().toLowerCase(); }

  // tiny markdown -> html
  function md(s){
    const esc = String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return esc
      .replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g,'<em>$1</em>')
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/\n{2,}/g,'</p><p>')
      .replace(/\n/g,'<br/>');
  }

  // API (accept only absolute http(s) override)
  const API_BASE = (() => {
    const override = qp('api');
    if (override && /^https?:\/\//i.test(override)) return override;
    return "https://customisationapp-new.vercel.app/api/templates";
  })();

  function normalizeRecord(t){
    const id   = clean(t.template_id);
    const name = clean(t.name);
    const TYPE = clean(t.TYPE || t.type || '');
    const typeKebab = t.type ? clean(t.type) : toSlug(TYPE);
    return { ...t, template_id:id, name, TYPE, type:typeKebab };
  }

  async function fetchTemplates(){
    const url = new URL(API_BASE);
    url.searchParams.set('slug','1');
    url.searchParams.set('type','kebab');
    const r = await fetch(url, { cache:'no-store' });
    const json = await r.json();
    if (!r.ok) throw new Error(JSON.stringify(json));
    return (json.records || []).map(normalizeRecord);
  }

  function pickTemplateByType(records, slug, preferId){
    const list = records.filter(r => (r.type || toSlug(r.TYPE || '')) === slug);
    if (!list.length) return null;
    if (preferId){
      const hit = list.find(r => keyLower(r.template_id) === keyLower(preferId));
      if (hit) return hit;
    }
    const withLayout = list.find(r => (Array.isArray(r.fields) && r.fields.length) || r.layout);
    return withLayout || list[0];
  }

  (async function boot(){
    const slug = hashSlug();
    document.getElementById('routeLine').textContent = `Personalised route: ${slug || '—'}`;

    const template_id = clean(qp('template_id'));
    const orderId = qp('orderId');
    const name = qp('name');
    const photo = qp('photo');

    try{
      const recs = await fetchTemplates();
      const tpl = pickTemplateByType(recs, slug, template_id);

      if (!tpl){
        document.getElementById('pageTitle').textContent = 'Template type not found';
        document.getElementById('err').classList.remove('hidden');
        document.getElementById('err').textContent = 'No template matches this TYPE. Check TYPE value and slug.';
        return;
      }

      const typeMeta = tpl.typeMeta || {};
      const title = typeMeta.title || `${titleCase((tpl.TYPE||'').replace(/-/g,' ')) || titleCase(slug)} — Personalised`;
      document.getElementById('pageTitle').textContent = title;

      const inst = typeMeta.instructions_md || typeMeta.instructions || '';
      document.getElementById('instructions').innerHTML = inst ? `<p>${md(inst)}</p>` : '—';

      const list = Array.isArray(typeMeta.requirements) ? typeMeta.requirements : [];
      const reqList = document.getElementById('reqList');
      const reqEmpty = document.getElementById('reqEmpty');
      reqList.innerHTML = '';
      if (list.length){
        reqEmpty.style.display = 'none';
        list.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item;
          reqList.appendChild(li);
        });
      } else {
        reqEmpty.style.display = 'block';
      }

      document.getElementById('ctx').textContent =
        `template_id=${template_id || '(auto ' + tpl.template_id + ')'} · orderId=${orderId || '—'} · name=${name || '—'}`;

      document.getElementById('tplName').textContent = `— ${tpl.name || ''}`;
      document.getElementById('openBtn').onclick = () => {
        try { sessionStorage.setItem('skipRouterOnce','1'); } catch {}
        const p = new URLSearchParams();
        p.set('template_id', template_id || tpl.template_id);
        if (orderId) p.set('orderId', orderId);
        if (name) p.set('name', name);
        if (photo) p.set('photo', photo);
        p.set('noroute','1');
        location.href = `../index.html?${p.toString()}`;
      };
    } catch(err){
      document.getElementById('pageTitle').textContent = 'Load error';
      const el = document.getElementById('err');
      el.classList.remove('hidden');
      el.textContent = (err && err.message) || String(err);
    }
  })();
  </script>
</body>
</html>
