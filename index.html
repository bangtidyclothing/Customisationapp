<script>
// 0) Optional: hard overrides by template_id or SKU
const ROUTE_OVERRIDE = {
  // 'tpl-ppna-photo': 'text-photo',
  // 'CO-CARD-PHOTO-12': 'text-photo',
  // 'tpl-mask-photo-001': 'photo-only',
};

// 1) Decide personalisation type
function getPersonalisationType(tpl) {
  // explicit override?
  const o = ROUTE_OVERRIDE[tpl.template_id] || ROUTE_OVERRIDE[tpl.SKU];
  if (o) return o;

  // (optional) use Airtable TYPE if you set it consistently
  // if (tpl.TYPE === 'mask') return 'photo-only';

  // infer from fields
  const fields = Array.isArray(tpl.fields) ? tpl.fields : [];
  const hasText  = fields.some(f => f.type === 'text');
  const hasPhoto = fields.some(f => f.type === 'image');

  if (hasText && hasPhoto) return 'text-photo';
  if (hasPhoto) return 'photo-only';
  if (hasText)  return 'text-only';
  return 'fallback';
}

// 2) Router: calls the right renderer
function startRoutedWorkflow(tpl, ctx) {
  const type = getPersonalisationType(tpl);
  if (type === 'text-only')   return renderTextOnly(tpl, ctx);
  if (type === 'photo-only')  return renderPhotoOnly(tpl, ctx);
  if (type === 'text-photo')  return renderTextAndPhoto(tpl, ctx);
  return renderFallback(tpl, ctx);
}

// 3) Renderers (minimal but production-friendly)

// utilities
function hideStartPanels(){
  document.getElementById('templates')?.classList.add('hidden');
  document.getElementById('simPanel')?.classList.add('hidden');
  document.getElementById('customiser')?.classList.remove('hidden');
}
function setHead(tpl){
  document.getElementById('c-title').textContent =
    `${tpl.template_id} — ${tpl.name || ''}`;
  document.getElementById('c-errors').textContent = '';
  document.getElementById('c-done').textContent = '';
  document.getElementById('c-form').innerHTML = '';
}

function renderTextOnly(tpl, ctx){
  hideStartPanels(); setHead(tpl);
  const form = document.getElementById('c-form');

  const textField = (tpl.fields || []).find(f => f.type === 'text') || { key:'text', label:'Your text', maxLength: 30, required: true };
  // reuse your existing builder lightly
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <label for="f_text">${textField.label || 'Your text'}</label>
    <input id="f_text" name="text" type="text" ${textField.maxLength ? `maxlength="${textField.maxLength}"`:''} value="${(ctx.prefill?.text||'').replace(/"/g,'&quot;')}">
    <small>${textField.maxLength ? `Max ${textField.maxLength} chars` : ''}</small>
  `;
  form.appendChild(wrap);

  wireSubmit(tpl, ctx, async () => {
    const text = document.getElementById('f_text').value.trim();
    const errs = [];
    if (textField.required && !text) errs.push('Text is required');
    return { errs, out: { text } };
  });
}

function renderPhotoOnly(tpl, ctx){
  hideStartPanels(); setHead(tpl);
  const form = document.getElementById('c-form');

  const imgField = (tpl.fields || []).find(f => f.type === 'image') || { key:'photo', label:'Upload photo', constraints:{ formats:['jpg','jpeg','png'], maxMB:10 } };

  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <label>${imgField.label || 'Upload photo'}</label>
    <input id="f_photo_url" type="url" placeholder="Paste image URL" value="${ctx.prefill?.photo || ''}">
    <input id="f_photo_file" type="file" accept="${(imgField.constraints?.formats||['jpg','jpeg','png']).map(x=>'.'+x).join(',')}">
    <img id="f_photo_prev" class="preview" style="display:none;">
    <small>
      ${(imgField.constraints?.minPx ? `Min ${imgField.constraints.minPx[0]}×${imgField.constraints.minPx[1]}px • `:'')}
      ${(imgField.constraints?.aspect ? `Aspect ${imgField.constraints.aspect} • `:'')}
      ${(imgField.constraints?.maxMB ? `Max ${imgField.constraints.maxMB}MB • `:'')}
      Formats: ${(imgField.constraints?.formats||['jpg','jpeg','png']).join(', ')}
    </small>
  `;
  form.appendChild(wrap);

  // mini preview
  const urlEl = document.getElementById('f_photo_url');
  const fileEl = document.getElementById('f_photo_file');
  const prevEl = document.getElementById('f_photo_prev');
  const show = (src)=>{ if(src){ prevEl.src=src; prevEl.style.display='block'; } else { prevEl.style.display='none'; } };
  urlEl.addEventListener('input', ()=> show(safeUrl(urlEl.value.trim())));
  fileEl.addEventListener('change', ()=>{
    const f = fileEl.files?.[0]; if(!f) return;
    show(URL.createObjectURL(f));
  });
  if (ctx.prefill?.photo) show(ctx.prefill.photo);

  wireSubmit(tpl, ctx, async () => {
    const url = (urlEl.value||'').trim();
    const file = fileEl.files?.[0];
    const errs = [];
    if (!url && !file) errs.push('Photo is required');
    // In production: upload file to storage; here, use URL or filename stub
    const photo = url || (file ? file.name : '');
    return { errs, out: { photo } };
  });
}

function renderTextAndPhoto(tpl, ctx){
  hideStartPanels(); setHead(tpl);

  // reuse the generic builder you already have:
  buildForm(tpl, ctx.prefill);

  wireSubmit(tpl, ctx, async () => {
    const { out, errs } = await collectForm(tpl);
    return { errs, out };
  });
}

function renderFallback(tpl, ctx){
  // falls back to the generic form
  renderTextAndPhoto(tpl, ctx);
}

// 4) Shared submit/cancel wiring
function wireSubmit(tpl, ctx, collector){
  const errors = document.getElementById('c-errors');
  const done = document.getElementById('c-done');
  const btnSubmit = document.getElementById('c-submit');
  const btnCancel = document.getElementById('c-cancel');

  btnSubmit.onclick = async () => {
    errors.textContent = ''; done.textContent = '';
    const { errs, out } = await collector();
    if (errs.length) { errors.textContent = errs.join(' • '); return; }

    // >>> your next step (server call / redirect / render proof)
    // Example:
    // await fetch('/api/create-job', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ template_id: tpl.template_id, orderId: ctx.orderId, inputs: out }) });

    done.textContent = 'All good — ready to generate!';
  };

  btnCancel.onclick = () => {
    document.getElementById('customiser').classList.add('hidden');
    document.getElementById('templates')?.classList.remove('hidden');
    document.getElementById('simPanel')?.classList.remove('hidden');
  };
}
</script>
