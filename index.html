<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bang Tidy ‚Äì Customisation App</title>
<style>
  body{font-family:system-ui,sans-serif;margin:24px;color:#111}
  .card{padding:16px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:16px}
  a{color:#2563eb;text-decoration:none}.muted{color:#6b7280}ul{padding-left:18px}
  #debug{position:fixed;right:12px;bottom:12px;width:min(56ch,92vw);max-height:42vh;overflow:auto;
         background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;
         font:12px/1.4 ui-monospace;box-shadow:0 8px 30px #0004}
  #debug b{color:#93c5fd}
</style>
</head>
<body>
<h1>Bang Tidy ‚Äì Customisation Framework</h1>
<div id="app" class="card">Loading‚Ä¶</div>
<div id="debug" aria-live="polite"><b>Debug</b><br/></div>

<script>
/* ===== Debug box mirrors console ===== */
(function(){
  const box = document.getElementById('debug');
  const add = (label, args) => {
    const msg = [...args].map(v => { try { return typeof v==='string'? v : JSON.stringify(v); } catch { return String(v); } }).join(' ');
    const line = document.createElement('div'); line.innerHTML = `<b>${label}</b> ${msg}`;
    box.appendChild(line); box.scrollTop = box.scrollHeight;
  };
  ['log','info','warn','error'].forEach(fn=>{
    const orig = console[fn].bind(console);
    console[fn] = (...a)=>{ add(fn.toUpperCase()+':', a); orig(...a); };
  });
  window.onerror = (msg, src, line, col, err) => console.error('[onerror]', msg, src, line+':'+col, err && err.stack);
  window.addEventListener('unhandledrejection', e => console.error('[unhandled]', e.reason));
})();

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const norm = s => (s ?? '').toString().trim();
const normU = s => norm(s).toUpperCase();

// One-time cache-buster per path+hash
(function forceOneRefresh(){
  const key = 'bt_refreshed_' + location.pathname + '|' + (location.hash || '');
  if (!sessionStorage.getItem(key)) {
    const url = new URL(location.href);
    url.searchParams.set('v', Date.now().toString());
    sessionStorage.setItem(key, '1');
    console.log('[refresh] add cache-buster and reload:', url.toString());
    location.replace(url.toString());
  }
})();

function getHash(){
  const h = (location.hash || '').slice(1);
  console.log('[router] hash', location.hash, 'parsed', h);
  return h;
}

// RAW GitHub URL
function templatesUrl(){
  const u = new URL('https://raw.githubusercontent.com/bangtidyclothing/Customisationapp/main/data/templates.json');
  u.searchParams.set('v', Date.now().toString());
  return u.toString();
}

// Fallback data (base64) ‚Äì guaranteed valid
const FALLBACK_B64 = btoa(JSON.stringify({
  records: [
    {
      template_id: "tpl-co-card-photo-12",
      TYPE: "beer-mat",
      sku_pattern: "photo-beer-mat-12",
      name: "Photo Beer Mat (12 pack)",
      SKU: "CO-CARD-PHOTO-12",
      fields: [
        { key: "photo", type: "image", label: "Upload your photo", required: true,
          constraints: { minPx: [1000,1000], aspect: "square", formats: ["jpg","jpeg","png"], maxMB: 10 } },
        { key: "text", type: "text", label: "Add optional text", required: false, maxLength: 30 }
      ]
    }
  ]
}));

function sanitizeJson(txt){
  return txt
    .replace(/^\uFEFF/, '')                // BOM
    .replace(/[\u201C\u201D]/g, '"')       // smart double quotes
    .replace(/[\u2018\u2019]/g, "'")       // smart single quotes
    .replace(/,\s*(?=[}\]])/g, '');        // trailing commas
}

// 1) Put your Airtable "Download CSV" link here:
const AIRTABLE_CSV = 'PASTE_YOUR_AIRTABLE_CSV_URL_HERE';

// Small CSV parser that handles quotes/commas/newlines
function parseCSV(csv) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  while (i < csv.length) {
    const c = csv[i];
    if (inQuotes) {
      if (c === '"') {
        if (csv[i+1] === '"') { field += '"'; i++; } // escaped quote
        else { inQuotes = false; }
      } else {
        field += c;
      }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') { row.push(field); field = ''; }
      else if (c === '\n') { row.push(field); rows.push(row); row = []; field=''; }
      else if (c === '\r') { /* ignore */ }
      else field += c;
    }
    i++;
  }
  // flush last field/row
  row.push(field); rows.push(row);
  // first row is header
  const header = rows.shift().map(h => h.trim());
  return rows.filter(r => r.length>1 && r.some(v => v && v.trim()!=='')).map(r => {
    const obj = {};
    header.forEach((h, idx) => obj[h] = r[idx] ?? '');
    return obj;
  });
}

// 2) REPLACE your loadTemplates() with this:
async function loadTemplates(){
  const url = new URL(https://airtable.com/appITTqqFG2y6USGq/shrVBLO80yoKUrIqZ/tblT3wQrUC5bVLNgi/viwL0cNUeL89MIUHp);
  url.searchParams.set('v', Date.now().toString()); // cache-bust
  console.log('[airtable] fetching CSV', url.toString());
  const res = await fetch(url.toString(), { cache: 'no-store' });
  console.log('[airtable] status', res.status);
  if (!res.ok) throw new Error('Airtable CSV not reachable');

  const csv = await res.text();
  console.log('[airtable] first200', csv.slice(0,200));

  const rows = parseCSV(csv);
  console.log('[airtable] rows', rows.length);

  // Map Airtable columns to the app‚Äôs record shape
  const records = rows.map(r => {
    // Safe JSON parses
    const parseJson = (s, fallback) => {
      try { return s ? JSON.parse(s) : fallback; } catch { return fallback; }
    };
    return {
      template_id: r.template_id,
      TYPE: r.TYPE,
      sku_pattern: r.sku_pattern,
      name: r.name,
      SKU: r.SKU,
      hero: r.hero || undefined,
      units_per_sheet: Number(r.units_per_sheet || 12),
      print_spec_json: parseJson(r.print_spec_json, undefined),
      imposition_json: parseJson(r.imposition_json, undefined),
      output_pattern: r.output_pattern || undefined,
      // fields_json column contains the inputs; parse into fields[]
      fields: parseJson(r.fields_json, [])
    };
  });

  const skus  = records.map(x => x.SKU);
  const pairs = records.map(x => `${x.TYPE}/${x.sku_pattern}`);
  console.log('[airtable] mapped', records.length, '| SKUs =', skus, '| pairs =', pairs);

  return { records };
}


/* ===== Views ===== */
async function renderHome(){
  $('app').innerHTML = `
    <p>Welcome üëã</p>
    <p>Try <a href="#/catalog">#/catalog</a>, <code>#/sku/CO-CARD-PHOTO-12</code>, or <code>#/t/beer-mat/photo-beer-mat-12</code>.</p>`;
}

async function renderCatalog(){
  const app = $('app'); app.innerHTML = "<p class='muted'>Loading catalog‚Ä¶</p>";
  try{
    const data = await loadTemplates();
    if (!data.records?.length){ app.innerHTML = "<p>No templates found.</p>"; return; }
    const items = data.records.map(r =>
      `<li><a href="#/t/${encodeURIComponent(r.TYPE)}/${encodeURIComponent(r.sku_pattern)}">${r.name}</a>
         <span class="muted">(${r.SKU})</span></li>`).join('');
    app.innerHTML = `<div class="card"><h2>Catalog</h2><ul>${items}</ul></div>`;
  }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
}

async function renderSku(skuRaw){
  const app = $('app'); app.innerHTML = "<p class='muted'>Resolving SKU‚Ä¶</p>";
  try{
    const sku = normU(skuRaw);
    const data = await loadTemplates();
    const available = (data.records||[]).map(r => normU(r.SKU || r.sku));
    console.log('[sku] looking for', sku, 'in', available);
    const rec = (data.records||[]).find(r => normU(r.SKU || r.sku) === sku);
    if (!rec){
      app.innerHTML = `<div class="card">
        <p><b>Template not found for that SKU.</b></p>
        <p class="muted">Asked: ${skuRaw}</p>
        <p>Available SKUs:</p>
        <ul>${available.map(x=>`<li>${x}</li>`).join('')}</ul>
        <p><a href="#/catalog">‚Üê Back to catalog</a></p>
      </div>`;
      return;
    }
    const target = `#/t/${rec.TYPE}/${rec.sku_pattern}`;
    console.log('[sku] resolved', skuRaw, '‚Üí', target);
    location.hash = target;
  }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
}

async function renderTemplate(typeRaw, slugRaw){
  const app = $('app'); app.innerHTML = "<p class='muted'>Loading template‚Ä¶</p>";
  try{
    const type = norm(typeRaw);
    const slug = norm(slugRaw);
    const data = await loadTemplates();
    console.log('[template] seeking', `${type}/${slug}`);
    console.warn('[template] available', (data.records||[]).map(r => `${r.TYPE}/${r.sku_pattern}`));
    const rec = (data.records||[]).find(r => r.TYPE === type && r.sku_pattern === slug);
    if (!rec){
      app.innerHTML = `<div class="card">
        <p><b>Template not found.</b></p>
        <p class="muted">Asked: ${typeRaw} / ${slugRaw}</p>
        <p>Available:</p>
        <ul>${(data.records||[]).map(r=>`<li>${r.TYPE}/${r.sku_pattern}</li>`).join('')}</ul>
        <p><a href="#/catalog">‚Üê Back to catalog</a></p>
      </div>`;
      return;
    }
    app.innerHTML = `
      <div class="card">
        <h2>${rec.name}</h2>
        <p class="muted">SKU: ${rec.SKU}</p>
        <p>Inputs:</p>
        <ul>${(rec.fields||[]).map(f=>`<li><strong>${f.label||f.key}</strong> ‚Äì ${f.type}</li>`).join('')}</ul>
        <p><a href="#/catalog">‚Üê Back to catalog</a></p>
      </div>`;
  }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
}

/* ===== Router ===== */
async function router(){
  const h = getHash();
  const segs = h.split('/').filter(Boolean);
  console.log('[router] segs', segs);
  if (!h) return renderHome();
  if (segs[0] === 'catalog') return renderCatalog();
  if (segs[0] === 'sku' && segs[1]) return renderSku(decodeURIComponent(segs[1]));
  if (segs[0] === 't' && segs[1] && segs[2]) return renderTemplate(decodeURIComponent(segs[1]), decodeURIComponent(segs[2]));
  $('app').innerHTML = "<p>404 ‚Äì Page not found</p>";
}

window.addEventListener('hashchange', router);
window.addEventListener('DOMContentLoaded', () => {
  router();
  setTimeout(router, 0);
  setTimeout(router, 50);
});
</script>
</body>
</html>
