<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bang Tidy â€“ Customisation App</title>
<style>
  body{font-family:system-ui,sans-serif;margin:24px;color:#111}
  .card{padding:16px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:16px}
  a{color:#2563eb;text-decoration:none}.muted{color:#6b7280}ul{padding-left:18px}
  #debug{position:fixed;right:12px;bottom:12px;width:min(52ch,92vw);max-height:42vh;overflow:auto;
         background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;
         font:12px/1.4 ui-monospace;box-shadow:0 8px 30px #0004}
  #debug b{color:#93c5fd}
</style>
</head>
<body>
<h1>Bang Tidy â€“ Customisation Framework</h1>
<div id="app" class="card">Loadingâ€¦</div>
<div id="debug" aria-live="polite"><b>Debug</b><br/></div>

<script>
  /* ========= Debug box mirrors console (useful on iPad) ========= */
  (function(){
    const box = document.getElementById('debug');
    const add = (label, args) => {
      const msg = [...args].map(v => {
        try { return typeof v==='string' ? v : JSON.stringify(v); } catch { return String(v); }
      }).join(' ');
      const line = document.createElement('div');
      line.innerHTML = `<b>${label}</b> ${msg}`;
      box.appendChild(line);
      box.scrollTop = box.scrollHeight;
    };
    ['log','info','warn','error'].forEach(fn=>{
      const orig = console[fn].bind(console);
      console[fn] = (...a)=>{ add(fn.toUpperCase()+':', a); orig(...a); };
    });
    // Catch fatal errors too
    window.onerror = (msg, src, line, col, err) => console.error('[onerror]', msg, src, line+':'+col, err && err.stack);
    window.addEventListener('unhandledrejection', e => console.error('[unhandled]', e.reason));
  })();

  /* ========= Helpers ========= */
  const $ = id => document.getElementById(id);
  const TPL_URL = './data/templates.json'; // must exist at data/templates.json (lowercase)

  // One-time forced refresh with cache-buster (?v=timestamp), safe against loops
  (function forceOneRefresh(){
    const key = 'bt_refreshed_' + location.pathname; // per-path flag
    const already = sessionStorage.getItem(key);
    if (!already) {
      const url = new URL(location.href);
      if (!url.searchParams.has('v')) {
        url.searchParams.set('v', Date.now().toString());
        sessionStorage.setItem(key, '1');
        console.log('[refresh] adding cache-buster and reloading:', url.toString());
        location.replace(url.toString());
      }
    }
  })();

  function getHash(){ const h=(location.hash||'').slice(1); console.log('[router] hash', location.hash, 'parsed', h); return h; }

  async function loadTemplates(){
    console.log('[data] fetching', TPL_URL);
    const res = await fetch(TPL_URL, { cache: 'no-store' });
    console.log('[data] status', res.status);
    if(!res.ok) throw new Error('templates.json not found');
    const json = await res.json();
    console.log('[data] records', json.records?.length||0);
    return json;
  }

  /* ========= Views ========= */
  async function renderHome(){
    $('app').innerHTML = `
      <p>Welcome ðŸ‘‹</p>
      <p>Try <a href="#/catalog">#/catalog</a> or a SKU link like <code>#/sku/CO-CARD-PHOTO-12</code>.</p>
      <p class="muted">This page auto-adds <code>?v=timestamp</code> once to bust cache for direct links.</p>`;
  }

  async function renderCatalog(){
    const app = $('app'); app.innerHTML = "<p class='muted'>Loading catalogâ€¦</p>";
    try{
      const data = await loadTemplates();
      if(!data.records?.length){ app.innerHTML = "<p>No
