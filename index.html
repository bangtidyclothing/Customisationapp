<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bang Tidy ‚Äì Customisation App</title>
<style>
  body{font-family:system-ui,sans-serif;margin:24px;color:#111}
  .card{padding:16px;border:1px solid #e5e7eb;border-radius:12px;margin-bottom:16px}
  a{color:#2563eb;text-decoration:none}.muted{color:#6b7280}ul{padding-left:18px}
  #debug{position:fixed;right:12px;bottom:12px;width:min(56ch,92vw);max-height:42vh;overflow:auto;
         background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px;
         font:12px/1.4 ui-monospace;box-shadow:0 8px 30px #0004}
  #debug b{color:#93c5fd}
</style>
</head>
<body>
<h1>Bang Tidy ‚Äì Customisation Framework</h1>
<div id="app" class="card">Loading‚Ä¶</div>
<div id="debug" aria-live="polite"><b>Debug</b><br/></div>

<script>
  /* ===== Debug box mirrors console (good on iPad) ===== */
  (function(){
    const box = document.getElementById('debug');
    const add = (label, args) => {
      const msg = [...args].map(v => { try { return typeof v==='string'? v : JSON.stringify(v); } catch { return String(v); } }).join(' ');
      const line = document.createElement('div'); line.innerHTML = `<b>${label}</b> ${msg}`;
      box.appendChild(line); box.scrollTop = box.scrollHeight;
    };
    ['log','info','warn','error'].forEach(fn=>{
      const orig = console[fn].bind(console);
      console[fn] = (...a)=>{ add(fn.toUpperCase()+':', a); orig(...a); };
    });
    window.onerror = (msg, src, line, col, err) => console.error('[onerror]', msg, src, line+':'+col, err && err.stack);
    window.addEventListener('unhandledrejection', e => console.error('[unhandled]', e.reason));
  })();

  /* ===== Helpers ===== */
  const $ = id => document.getElementById(id);

  // One-time cache-buster per path+hash
  (function forceOneRefresh(){
    const key = 'bt_refreshed_' + location.pathname + '|' + (location.hash || '');
    if (!sessionStorage.getItem(key)) {
      const url = new URL(location.href);
      url.searchParams.set('v', Date.now().toString());
      sessionStorage.setItem(key, '1');
      console.log('[refresh] add cache-buster and reload:', url.toString());
      location.replace(url.toString());
    }
  })();

  const norm = s => (s ?? '').toString().trim();
  const normU = s => norm(s).toUpperCase();

  function getHash(){
    const h = (location.hash || '').slice(1);
    console.log('[router] hash', location.hash, 'parsed', h);
    return h;
  }

  // Always fetch templates.json from the repo raw URL
  function templatesUrl(){
    const u = new URL(
      'https://raw.githubusercontent.com/bangtidyclothing/Customisationapp/main/data/templates.json'
    );
    u.searchParams.set('v', Date.now().toString()); // cache-buster
    return u.toString();
  }

  async function loadTemplates(){
    const url = templatesUrl();
    console.log('[data] fetching', url);
    const res = await fetch(url, { cache: 'no-store' });
    console.log('[data] status', res.status);
    const txt = await res.text();
    console.log('[data] first300', txt.slice(0,300));
    if (!res.ok) throw new Error('templates.json not found');
    let json; try { json = JSON.parse(txt); } catch(e){ console.error('[data] JSON parse error', e.message); throw e; }
    const skus = (json.records||[]).map(r => r.SKU || r.sku);
    const pairs = (json.records||[]).map(r => `${r.TYPE}/${r.sku_pattern}`);
    console.log('[data] records', json.records?.length || 0, '| SKUs =', skus, '| pairs =', pairs);
    return json;
  }

  /* ===== Views ===== */
  async function renderHome(){
    $('app').innerHTML = `
      <p>Welcome üëã</p>
      <p>Try <a href="#/catalog">#/catalog</a>, <code>#/sku/CO-CARD-PHOTO-12</code>, or <code>#/t/beer-mat/photo-beer-mat-12</code>.</p>`;
  }

  async function renderCatalog(){
    const app = $('app'); app.innerHTML = "<p class='muted'>Loading catalog‚Ä¶</p>";
    try{
      const data = await loadTemplates();
      if (!data.records?.length){ app.innerHTML = "<p>No templates found.</p>"; return; }
      const items = data.records.map(r =>
        `<li><a href="#/t/${encodeURIComponent(r.TYPE)}/${encodeURIComponent(r.sku_pattern)}">${r.name}</a>
           <span class="muted">(${r.SKU})</span></li>`).join('');
      app.innerHTML = `<div class="card"><h2>Catalog</h2><ul>${items}</ul></div>`;
    }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
  }

  async function renderSku(skuRaw){
    const app = $('app'); app.innerHTML = "<p class='muted'>Resolving SKU‚Ä¶</p>";
    try{
      const sku = normU(skuRaw);
      const data = await loadTemplates();
      const available = (data.records||[]).map(r => normU(r.SKU || r.sku));
      console.log('[sku] looking for', sku, 'in', available);
      const rec = (data.records||[]).find(r => normU(r.SKU || r.sku) === sku);
      if (!rec){
        app.innerHTML = `<div class="card">
          <p><b>Template not found for that SKU.</b></p>
          <p class="muted">Asked: ${skuRaw}</p>
          <p>Available SKUs:</p>
          <ul>${available.map(x=>`<li>${x}</li>`).join('')}</ul>
          <p><a href="#/catalog">‚Üê Back to catalog</a></p>
        </div>`;
        return;
      }
      const target = `#/t/${rec.TYPE}/${rec.sku_pattern}`;
      console.log('[sku] resolved', skuRaw, '‚Üí', target);
      location.hash = target;
    }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
  }

  async function renderTemplate(typeRaw, slugRaw){
    const app = $('app'); app.innerHTML = "<p class='muted'>Loading template‚Ä¶</p>";
    try{
      const type = norm(typeRaw);
      const slug = norm(slugRaw);
      const data = await loadTemplates();
      console.log('[template] seeking', `${type}/${slug}`);
      console.warn('[template] available', (data.records||[]).map(r => `${r.TYPE}/${r.sku_pattern}`));
      const rec = (data.records||[]).find(r => r.TYPE === type && r.sku_pattern === slug);
      if (!rec){
        app.innerHTML = `<div class="card">
          <p><b>Template not found.</b></p>
          <p class="muted">Asked: ${typeRaw} / ${slugRaw}</p>
          <p>Available:</p>
          <ul>${(data.records||[]).map(r=>`<li>${r.TYPE}/${r.sku_pattern}</li>`).join('')}</ul>
          <p><a href="#/catalog">‚Üê Back to catalog</a></p>
        </div>`;
        return;
      }
      app.innerHTML = `
        <div class="card">
          <h2>${rec.name}</h2>
          <p class="muted">SKU: ${rec.SKU}</p>
          <p>Inputs:</p>
          <ul>${(rec.fields||[]).map(f=>`<li><strong>${f.label||f.key}</strong> ‚Äì ${f.type}</li>`).join('')}</ul>
          <p><a href="#/catalog">‚Üê Back to catalog</a></p>
        </div>`;
    }catch(e){ console.error(e); app.innerHTML = `<p style="color:#b91c1c"><b>Error:</b> ${e.message}</p>`; }
  }

  /* ===== Router ===== */
  async function router(){
    const h = getHash();
    const segs = h.split('/').filter(Boolean);
    console.log('[router] segs', segs);
    if (!h) return renderHome();
    if (segs[0] === 'catalog') return renderCatalog();
    if (segs[0] === 'sku' && segs[1]) return renderSku(decodeURIComponent(segs[1]));
    if (segs[0] === 't' && segs[1] && segs[2]) return renderTemplate(decodeURIComponent(segs[1]), decodeURIComponent(segs[2]));
    $('app').innerHTML = "<p>404 ‚Äì Page not found</p>";
  }

  window.addEventListener('hashchange', router);
  window.addEventListener('DOMContentLoaded', () => {
    router();
    setTimeout(router, 0);
    setTimeout(router, 50);
  });
</script>
</body>
</html>
